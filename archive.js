// ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ Ïã§Ìñâ
document.addEventListener("DOMContentLoaded", function () {
    mergeProjects();
    setupFilterButtons();
    setupSearchEvents();
});

//============================================
//Ïù¥ÎØ∏ÏßÄ ÎìúÎûòÍ∑∏ Î∞©ÏßÄ

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("img").forEach((img) => {
        img.setAttribute("draggable", "false");
        img.addEventListener("mousedown", (e) => e.preventDefault());
    });
});


//============================================
// Ïä§ÌÅ¨Î°§ Ï†úÏñ¥ (Ï†ÑÏó≠ Î≥ÄÏàò ÌôúÏö©)
document.addEventListener("wheel", function (event) {
    const { isMobile, isTablet } = getScreenType();
    const leftContainer = document.querySelector(".left");
    const scrollContainer = document.querySelector(".left-scroll-container");
    const rightContainer = document.querySelector(".right");

    if (!leftContainer || !scrollContainer || !rightContainer) return;

    const hoveredElement = document.elementFromPoint(event.clientX, event.clientY);

    if (isMobile || isTablet) {
        // üìå Î™®Î∞îÏùºÏóêÏÑúÎäî `.left-scroll-container`ÏóêÏÑú Ïä§ÌÅ¨Î°§Ìï¥ÎèÑ `.left`Í∞Ä Ïä§ÌÅ¨Î°§Îê®
        if (scrollContainer.contains(hoveredElement)) {
            leftContainer.scrollTop += event.deltaY;
        } else {
            leftContainer.scrollTop += event.deltaY;
        }
    } else {
        // üìå Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎäî Í∏∞Î≥∏ ÎèôÏûë
        if (rightContainer.contains(hoveredElement)) {
            rightContainer.scrollTop += event.deltaY;
        } else {
            scrollContainer.scrollTop += event.deltaY;
        }
    }

    event.preventDefault(); // Í∏∞Î≥∏ Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
}, { passive: false });



//============================================
// Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º ÌïòÎÇòÎ°ú Ìï©ÏπòÎäî Î∞∞Ïó¥
const allProjects = [];
let activeFilters = [];
let filteredProjects = [];

//============================================
// ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Ìï©ÏπòÎäî Ìï®Ïàò
function mergeProjects() {
    if (window.yawayatsProjects) allProjects.push(...window.yawayatsProjects);
    if (window.oslProjects) allProjects.push(...window.oslProjects);
    if (window.hipdProjects) allProjects.push(...window.hipdProjects);
    if (window.vroomProjects) allProjects.push(...window.vroomProjects);
    if (window.jotaProjects) allProjects.push(...window.jotaProjects);

    window.projects = [...allProjects]; // Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î¶¨Ïä§Ìä∏ Î≥µÏÇ¨
    filteredProjects = [...allProjects]; // ÌïÑÌÑ∞ÎßÅÏùÑ ÏúÑÌïú Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï

    console.log("All projects merged:", window.projects);
    generateProjectList();
}

//============================================
// ÌîÑÎ°úÏ†ùÌä∏ Î¶¨Ïä§Ìä∏ ÏÉùÏÑ± Ìï®Ïàò
function generateProjectList() {
    const projectContainer = document.getElementById("project-list");
    projectContainer.innerHTML = "";

    if (filteredProjects.length === 0) {
        console.log("Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå! ÌîÑÎ°úÏ†ùÌä∏ Î¶¨Ïä§Ìä∏Î•º Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§.");
        return;
    }

    filteredProjects.forEach((project) => {
        const projectItem = document.createElement("div");
        projectItem.classList.add("project-item");

        projectItem.innerHTML = `
            <div class="thumbnail-container">
                <img src="${project.thumbnail}" alt="${project.title}" class="thumbnail">
            </div>
            <div class="project-info-container">
                <div class="project-info-container-top">
                   <p class="project-club">${project.club}</p>
                   <p class="author">${project.author}</p>
                </div>
                <h3 class="project-title">${project.title}</h3>
            </div>
        `;

        projectContainer.appendChild(projectItem);
    });

    setupProjectClickEvents();
}

//============================================
// ÌïÑÌÑ∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
function setupFilterButtons() {
    const buttons = document.querySelectorAll(".filter-btn");

    buttons.forEach(button => {
        button.addEventListener("click", function () {
            const club = this.dataset.club;

            if (activeFilters.includes(club)) {
                activeFilters = activeFilters.filter(filter => filter !== club);
                this.classList.remove("filter", "active");
            } else {
                activeFilters.push(club);
                this.classList.add("filter", "active");
            }

            console.log("ÌòÑÏû¨ ÌïÑÌÑ∞:", activeFilters);

            applyFilters();
        });
    });

    generateProjectList();
    
}

//============================================
// Í≤ÄÏÉâÏñ¥ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
function setupSearchEvents() {
    document.getElementById("search-input").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            executeSearch();
        }
    });

    document.getElementById("search-button").addEventListener("click", function () {
        executeSearch();
    });
}

//============================================
// Í≤ÄÏÉâ Ïã§Ìñâ
function executeSearch() {
    const searchInput = document.getElementById("search-input").value.trim().toLowerCase();

    if (searchInput === "") {
        // Í≤ÄÏÉâÏñ¥Í∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõê
        filteredProjects = [...window.projects];
    } else {
        // Í∏∞Ï°¥ ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî (Î≤ÑÌäºÎèÑ Ï¥àÍ∏∞Ìôî)
        activeFilters = [];
        document.querySelectorAll(".filter-btn.filter.active").forEach(btn => {
            btn.classList.remove("filter", "active");
        });

        filteredProjects = window.projects.filter(project => {
            const titleMatch = project.title ? project.title.toLowerCase().includes(searchInput) : false;
            const authorText = project.author ? (Array.isArray(project.author) ? project.author.join(", ") : project.author) : "";
            const authorMatch = authorText.toLowerCase().includes(searchInput);

            return titleMatch || authorMatch;
        });
    }

    console.log("Í≤ÄÏÉâ Í≤∞Í≥º:", filteredProjects);
    generateProjectList();
}

//============================================
// ÌïÑÌÑ∞ Ï†ÅÏö© Ìï®Ïàò (Í≤ÄÏÉâ + ÌïÑÌÑ∞ Ï°∞Ìï©)
function applyFilters() {
    if (activeFilters.length > 0) {
        filteredProjects = window.projects.filter(project =>
            activeFilters.includes(project.club.trim())
        );
    } else {
        filteredProjects = [...window.projects];
    }

    console.log("ÌòÑÏû¨ ÌïÑÌÑ∞ÎßÅÎêú ÌîÑÎ°úÏ†ùÌä∏ Î¶¨Ïä§Ìä∏:", filteredProjects);
    generateProjectList();
}

//============================================
// ÌîÑÎ°úÏ†ùÌä∏ ÌÅ¥Î¶≠ Ïãú Ïö∞Ï∏° Ï†ïÎ≥¥ ÌëúÏãú
function setupProjectClickEvents() {
    const projectItems = document.querySelectorAll(".project-item");
    const right = document.querySelector(".right");
    const rightPanel = document.querySelector(".right");

    projectItems.forEach((item, index) => {
        item.addEventListener("click", function () {
            projectItems.forEach((el) => el.classList.remove("clicked-project"));
            this.classList.add("clicked-project");

            const project = filteredProjects[index];
            const { isMobile, isTablet } = getScreenType();

            if (project) {
                // ‚úÖ return Î≤ÑÌäºÏùÑ Ìè¨Ìï®Ìïú ÏÉÅÌÉúÎ°ú Ïö∞Ï∏° Ìå®ÎÑê ÏÉùÏÑ±
                rightPanel.innerHTML = `
                    <div class="project-detail">
                        <div class="project-detail-info">
                            ${ (isMobile || isTablet ) ? `
                                <div class="right-return-button">
                                    <svg width="18" height="30" viewBox="0 0 18 30" fill="none">
                                        <path d="M16.667 1.66797L3.33366 15.0013L16.667 28.3346" stroke="#A9A9A9" stroke-width="3.33333"/>
                                    </svg>
                                </div>
                            ` : ""}
                            <p class="club-name">${project.club}</p>
                            <div class="project-detail-info-bottom">
                                <h2>${project.title}</h2>
                                <p class="project-author">${project.author}</p>
                            </div>
                        </div>

                        <div class="media-container">
                            ${project.media
                                ? project.media.map((item) => {
                                    if (item.endsWith(".mp4")) {
                                        return `<video class="detail-video" controls>
                                                    <source src="${item}" type="video/mp4">
                                                    Your browser does not support the video tag.
                                                </video>`;
                                    } else {
                                        return `<img src="${item}" alt="${project.title}" class="detail-image">`;
                                    }
                                }).join("")
                                : `<img src="${project.thumbnail}" alt="${project.title}" class="detail-image">`
                            }
                        </div>

                        <div class="description">
                            <p class="descText">${project.descText || "ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§."}</p>
                            ${project.contact ? createContactSection(project.contact) : ""}
                        </div>
                    </div>
                `;

                // ‚úÖ return Î≤ÑÌäº Í∞ïÏ†ú Ï∂îÍ∞Ä (ÌòπÏãúÎùºÎèÑ Ïïà Î∂ôÏóàÏùÑ Í≤ΩÏö∞ ÎåÄÎπÑ)
                setTimeout(() => checkAndAddReturnButton(), 10);
                addReturnButtonEvent();
            }
        });
    });
}





function observeRightPanel() {
    const rightPanel = document.querySelector(".right");

    // Ïù¥ÎØ∏ return arrowÍ∞Ä ÏûàÏúºÎ©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
    if (document.querySelector(".right-return-button")) return;

    const observer = new MutationObserver(() => {
        if (document.querySelector(".right .project-detail-info")) {
            observer.disconnect();
            checkAndAddReturnButton(); // ‚úÖ right Ìå®ÎÑêÏù¥ ÏÉùÍ∏∞Î©¥ return arrow Ï∂îÍ∞Ä
        }
    });

    observer.observe(rightPanel, { childList: true, subtree: true });
}




//============================================
// Contact Ï†ïÎ≥¥ Ï†ïÎ¶¨ÌïòÎäî Ìï®Ïàò
function createContactSection(contact) {
    if (!contact || Object.keys(contact).length === 0) return "";

    return `
        <div class="contact-section">
            <hr class="contact-line">
            ${Object.keys(contact)
            .map((key) => {
                const value = contact[key];
                return `
                    <div class="contact-item">
                        <span class="contact-label"><strong>${key}</strong></span>
                        <span class="contact-divider">|</span>
                        ${value.includes("http")
                        ? `<a href="${value}" target="_blank" class="contact-value address">${value}</a>`
                        : `<span class="contact-value">${value}</span>`}
                    </div>
                `;
            })
            .join("")}
        </div>
    `;
}


//============================================
//Î™®Î∞îÏùºÏö© Ïö∞Ï∏° ÌéòÏù¥ÏßÄ Ï≤òÎ¶¨


document.addEventListener("DOMContentLoaded", function () {
    const projectItems = document.querySelectorAll(".project-item");
    const right = document.querySelector(".right");
    let startX = 0;
    let endX = 0;

    if (!right || !projectItems.length) return;

    // üìå ÌîÑÎ°úÏ†ùÌä∏ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ïãú right ÌëúÏãú
    projectItems.forEach((item) => {
        item.addEventListener("click", function () {
            right.classList.add("active"); // right Îì±Ïû•
        });
    });

    // üìå Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïä§ÏôÄÏù¥ÌîÑÌïòÎ©¥ right Îã´Í∏∞
    right.addEventListener("touchstart", function (event) {
        startX = event.touches[0].clientX;
    });

    right.addEventListener("touchmove", function (event) {
        endX = event.touches[0].clientX;
    });

    right.addEventListener("touchend", function () {
        if (endX - startX > 50) { // Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïä§ÏôÄÏù¥ÌîÑÌïòÎ©¥ Îã´Í∏∞
            right.classList.remove("active");
        }
    });

    // üìå ÎßàÏö∞Ïä§ Ìú† Ïä§ÌÅ¨Î°§ ÌóàÏö©
    right.addEventListener("wheel", function (event) {
        right.scrollTop += event.deltaY;
        event.preventDefault(); // Í∏∞Î≥∏ Ïä§ÌÅ¨Î°§ Ï∞®Îã® Î∞©ÏßÄ
    }, { passive: false });
});
